"""
Утилиты для работы с кодами классификации расходов и доходов
"""
from typing import Dict, Optional


def parse_expense_code(code: str) -> Dict[str, str]:
    """
    Разбор 20-разрядного кода расходов на компоненты
    
    Структура кода: ГРБС(3) + код_Р(2) + код_ПР(2) + код_ЦС(10) + код_ВР(3)
    
    Args:
        code: 20-разрядный код расходов (может содержать пробелы)
        
    Returns:
        Словарь с компонентами:
        {
            'ГРБС': '000',
            'код_Р': '01',
            'код_ПР': '00',
            'код_ЦС': '0000000000',
            'код_ВР': '000',
            'полный_код': '0000100000000000000000'
        }
        Или пустой словарь, если код невалидный
    """
    if not code:
        return {}
    
    # Убираем пробелы
    code = code.replace(' ', '').replace('\xa0', '')
    
    if len(code) != 20:
        return {}
    
    return {
        'ГРБС': code[0:3],
        'код_Р': code[3:5],
        'код_ПР': code[5:7],
        'код_ЦС': code[7:17],
        'код_ВР': code[17:20],
        'полный_код': code
    }


def build_expense_code(
    ГРБС: str = '000',
    код_Р: str = '00',
    код_ПР: str = '00',
    код_ЦС: str = '0000000000',
    код_ВР: str = '000'
) -> str:
    """
    Сборка 20-разрядного кода расходов из компонентов
    
    Args:
        ГРБС: 3 разряда (код главного распорядителя бюджетных средств)
        код_Р: 2 разряда (код раздела)
        код_ПР: 2 разряда (код подраздела)
        код_ЦС: 10 разрядов (код целевой статьи)
        код_ВР: 3 разряда (код вида расходов)
        
    Returns:
        20-разрядный код (без пробелов)
    """
    # Убираем пробелы и дополняем нулями слева
    ГРБС = str(ГРБС).replace(' ', '').zfill(3)[:3]
    код_Р = str(код_Р).replace(' ', '').zfill(2)[:2]
    код_ПР = str(код_ПР).replace(' ', '').zfill(2)[:2]
    код_ЦС = str(код_ЦС).replace(' ', '').zfill(10)[:10]
    код_ВР = str(код_ВР).replace(' ', '').zfill(3)[:3]
    
    return f"{ГРБС}{код_Р}{код_ПР}{код_ЦС}{код_ВР}"


def parse_income_code(code: str) -> Dict[str, str]:
    """
    Разбор 20-разрядного кода доходов на компоненты
    
    Структура кода:
    код_ГАДБ(3) + код_группы_ДБ(1) + код_подгруппы_ДБ(2) + 
    код_статьи_подстатьи_ДБ(5) + код_элемента_ДБ(2) + 
    код_группы_ПДБ(4) + код_группы_АПДБ(3)
    
    Args:
        code: 20-разрядный код доходов (может содержать пробелы)
        
    Returns:
        Словарь с компонентами:
        {
            'код_ГАДБ': '000',
            'код_группы_ДБ': '1',
            'код_подгруппы_ДБ': '00',
            'код_статьи_подстатьи_ДБ': '00000',
            'код_элемента_ДБ': '00',
            'код_группы_ПДБ': '0000',
            'код_группы_АПДБ': '000',
            'полный_код': '00010000000000000000'
        }
        Или пустой словарь, если код невалидный
    """
    if not code:
        return {}
    
    # Убираем пробелы
    code = code.replace(' ', '').replace('\xa0', '')
    
    if len(code) != 20:
        return {}
    
    return {
        'код_ГАДБ': code[0:3],
        'код_группы_ДБ': code[3:4],
        'код_подгруппы_ДБ': code[4:6],
        'код_статьи_подстатьи_ДБ': code[6:11],
        'код_элемента_ДБ': code[11:13],
        'код_группы_ПДБ': code[13:17],
        'код_группы_АПДБ': code[17:20],
        'полный_код': code
    }


def build_income_code(
    код_ГАДБ: str = '000',
    код_группы_ДБ: str = '0',
    код_подгруппы_ДБ: str = '00',
    код_статьи_подстатьи_ДБ: str = '00000',
    код_элемента_ДБ: str = '00',
    код_группы_ПДБ: str = '0000',
    код_группы_АПДБ: str = '000'
) -> str:
    """
    Сборка 20-разрядного кода доходов из компонентов
    
    Args:
        код_ГАДБ: 3 разряда (код группы аналитики доходов бюджетов)
        код_группы_ДБ: 1 разряд (код группы доходов бюджетов)
        код_подгруппы_ДБ: 2 разряда (код подгруппы доходов бюджетов)
        код_статьи_подстатьи_ДБ: 5 разрядов (код статьи/подстатьи доходов бюджетов)
        код_элемента_ДБ: 2 разряда (код элемента доходов бюджетов)
        код_группы_ПДБ: 4 разряда (код группы подвидов доходов бюджетов)
        код_группы_АПДБ: 3 разряда (код аналитической группы подвидов доходов бюджетов)
        
    Returns:
        20-разрядный код (без пробелов)
    """
    # Убираем пробелы и дополняем нулями слева
    код_ГАДБ = str(код_ГАДБ).replace(' ', '').zfill(3)[:3]
    код_группы_ДБ = str(код_группы_ДБ).replace(' ', '').zfill(1)[:1]
    код_подгруппы_ДБ = str(код_подгруппы_ДБ).replace(' ', '').zfill(2)[:2]
    код_статьи_подстатьи_ДБ = str(код_статьи_подстатьи_ДБ).replace(' ', '').zfill(5)[:5]
    код_элемента_ДБ = str(код_элемента_ДБ).replace(' ', '').zfill(2)[:2]
    код_группы_ПДБ = str(код_группы_ПДБ).replace(' ', '').zfill(4)[:4]
    код_группы_АПДБ = str(код_группы_АПДБ).replace(' ', '').zfill(3)[:3]
    
    return (f"{код_ГАДБ}"
            f"{код_группы_ДБ}"
            f"{код_подгруппы_ДБ}"
            f"{код_статьи_подстатьи_ДБ}"
            f"{код_элемента_ДБ}"
            f"{код_группы_ПДБ}"
            f"{код_группы_АПДБ}")


def format_code_with_spaces(code: str, code_type: str = 'expense') -> str:
    """
    Форматирование кода с пробелами для отображения
    
    Args:
        code: Код без пробелов
        code_type: Тип кода ('expense' или 'income')
        
    Returns:
        Отформатированный код с пробелами
    """
    if not code:
        return ''
    
    code = code.replace(' ', '').replace('\xa0', '')
    
    if code_type == 'expense':
        # ГРБС(3) код_Р(2) код_ПР(2) код_ЦС(10) код_ВР(3)
        if len(code) == 20:
            return f"{code[0:3]} {code[3:5]} {code[5:7]} {code[7:17]} {code[17:20]}"
    elif code_type == 'income':
        # код_ГАДБ(3) код_группы_ДБ(1) код_подгруппы_ДБ(2) 
        # код_статьи_подстатьи_ДБ(5) код_элемента_ДБ(2) 
        # код_группы_ПДБ(4) код_группы_АПДБ(3)
        if len(code) == 20:
            return (f"{code[0:3]} {code[3:4]} {code[4:6]} {code[6:11]} "
                   f"{code[11:13]} {code[13:17]} {code[17:20]}")
    
    return code


def validate_expense_code(code: str) -> bool:
    """
    Валидация кода расходов
    
    Args:
        code: Код для проверки
        
    Returns:
        True, если код валидный (20 разрядов, только цифры)
    """
    if not code:
        return False
    
    code = code.replace(' ', '').replace('\xa0', '')
    
    if len(code) != 20:
        return False
    
    return code.isdigit()


def validate_income_code(code: str) -> bool:
    """
    Валидация кода доходов
    
    Args:
        code: Код для проверки
        
    Returns:
        True, если код валидный (20 разрядов, только цифры)
    """
    if not code:
        return False
    
    code = code.replace(' ', '').replace('\xa0', '')
    
    if len(code) != 20:
        return False
    
    return code.isdigit()

# Анализ функционала и интеграция с данными

## 1. Оценка функционала согласно IMPLEMENTATION_STATUS.md

### 1.1. Выполнено ✅

#### Расширение схемы базы данных
- ✅ Все необходимые справочники созданы
- ✅ Таблицы для решений созданы
- ✅ Нормализованные таблицы для значений форм созданы

#### Контроллеры
- ✅ `DocumentController` - базовая структура реализована
- ✅ `SolutionController` - базовая структура реализована

### 1.2. Требует доработки ⚠️

#### DocumentController
1. **Извлечение данных из формы** - ✅ Использует нормализованные данные
2. **Таблица 2 (доходы)** - ⚠️ Частично реализовано:
   - ✅ Фильтрация по уровням работает
   - ✅ Вычисление процента исполнения реализовано
   - ⚠️ Нужна фильтрация через справочник `ref_income_levels`
   - ⚠️ Нужно учитывать структуру кода доходов (20 разрядов)
3. **Таблица 3 (расходы)** - ✅ Реализовано
4. **Замена меток** - ⚠️ Многие метки не обрабатываются:
   - ⚠️ `<UvOst>`, `<UmOst>` - увеличение/уменьшение остатков (нужно вычислить)
   - ⚠️ Другие метки из кода 1С
5. **Диаграммы в Word** - ❌ Не реализовано

#### SolutionController
1. **Приложение 1 (доходы)** - ⚠️ Базовая логика есть:
   - ⚠️ Нужно учитывать структуру кода доходов (20 разрядов)
   - ⚠️ Нужно сохранять в БД с разбивкой по компонентам кода
2. **Приложение 2 (расходы)** - ⚠️ Базовая логика есть:
   - ⚠️ Нужно учитывать структуру кода расходов (20 разрядов: ГРБС+код_Р+код_ПР+код_ЦС+код_ВР)
   - ⚠️ Нужно сохранять в БД с разбивкой по компонентам
3. **Приложение 3 (расходы по ГРБС)** - ⚠️ Базовая логика есть:
   - ⚠️ Нужно учитывать структуру кода расходов
4. **Сохранение в БД** - ❌ Не реализовано
5. **Агрегация данных** - ❌ Не реализовано
6. **Создание записей в справочниках** - ❌ Не реализовано

## 2. Структура кодов классификации

### 2.1. Код расходов (20 разрядов)

Структура: `ГРБС(3) + код_Р(2) + код_ПР(2) + код_ЦС(10) + код_ВР(3)`

```
Позиции: 0-2   | 3-4   | 5-6   | 7-16      | 17-19
         ГРБС  | код_Р | код_ПР| код_ЦС    | код_ВР
Пример:  000   | 01    | 00    | 0000000000| 000
```

**Текущее состояние:**
- В таблице `expense_values` код хранится как `classification_code` (полный 20-разрядный код)
- В таблице `ref_expense_codes` есть поля: `код`, `код_Р`, `код_ПР`, `код_ЦС`, `код_ВР`
- В `SolutionController._process_appendix2` код формируется как конкатенация частей, но не разбивается на компоненты

**Что нужно:**
1. Добавить методы разбора 20-разрядного кода на компоненты
2. При сохранении данных решений сохранять компоненты отдельно
3. При поиске в справочниках учитывать структуру кода

### 2.2. Код доходов (20 разрядов)

Структура: `код_ГАДБ(3) + код_группы_ДБ(1) + код_подгруппы_ДБ(2) + код_статьи_подстатьи_ДБ(5) + код_элемента_ДБ(2) + код_группы_ПДБ(4) + код_группы_АПДБ(3)`

```
Позиции: 0-2   | 3     | 4-5   | 6-10           | 11-12 | 13-16      | 17-19
         ГАДБ  | группа| подгр.| статья/подстатья| элемент| группа_ПДБ| группа_АПДБ
Пример:  000   | 1     | 00    | 00000           | 00    | 0000       | 000
```

**Текущее состояние:**
- В таблице `income_values` код хранится как `classification_code` (полный 20-разрядный код)
- В таблице `ref_income_codes` код хранится целиком, без разбивки
- Справочники для компонентов созданы, но не используются при парсинге

**Что нужно:**
1. Добавить методы разбора 20-разрядного кода на компоненты
2. При сохранении данных решений сохранять компоненты отдельно
3. Использовать справочники компонентов для валидации и поиска

## 3. Увеличение и уменьшение остатков (<UvOst>, <UmOst>)

**Определение:**
- `<UvOst>` - увеличение остатков (положительное значение)
- `<UmOst>` - уменьшение остатков (отрицательное значение, но хранится как положительное)

**Примечание:**
Логика получения этих значений уже реализована в `DocumentController`. Значения берутся из `form_data.get('uv_ost', 0)` и `form_data.get('um_ost', 0)`. Переделывать логику получения не требуется.

## 4. План интеграции

### 4.1. Создание утилит для работы с кодами

#### 4.1.1. Утилита для разбора кода расходов

```python
# models/utils/code_utils.py

def parse_expense_code(code: str) -> Dict[str, str]:
    """
    Разбор 20-разрядного кода расходов на компоненты
    
    Args:
        code: 20-разрядный код расходов
        
    Returns:
        Словарь с компонентами: {'ГРБС': '000', 'код_Р': '01', ...}
    """
    if not code or len(code) != 20:
        return {}
    
    return {
        'ГРБС': code[0:3],
        'код_Р': code[3:5],
        'код_ПР': code[5:7],
        'код_ЦС': code[7:17],
        'код_ВР': code[17:20],
        'полный_код': code
    }

def build_expense_code(ГРБС: str, код_Р: str, код_ПР: str, код_ЦС: str, код_ВР: str) -> str:
    """
    Сборка 20-разрядного кода расходов из компонентов
    
    Args:
        ГРБС: 3 разряда
        код_Р: 2 разряда
        код_ПР: 2 разряда
        код_ЦС: 10 разрядов
        код_ВР: 3 разряда
        
    Returns:
        20-разрядный код
    """
    return f"{ГРБС:0>3}{код_Р:0>2}{код_ПР:0>2}{код_ЦС:0>10}{код_ВР:0>3}"
```

#### 4.1.2. Утилита для разбора кода доходов

```python
def parse_income_code(code: str) -> Dict[str, str]:
    """
    Разбор 20-разрядного кода доходов на компоненты
    
    Args:
        code: 20-разрядный код доходов
        
    Returns:
        Словарь с компонентами
    """
    if not code or len(code) != 20:
        return {}
    
    return {
        'код_ГАДБ': code[0:3],
        'код_группы_ДБ': code[3:4],
        'код_подгруппы_ДБ': code[4:6],
        'код_статьи_подстатьи_ДБ': code[6:11],
        'код_элемента_ДБ': code[11:13],
        'код_группы_ПДБ': code[13:17],
        'код_группы_АПДБ': code[17:20],
        'полный_код': code
    }

def build_income_code(
    код_ГАДБ: str,
    код_группы_ДБ: str,
    код_подгруппы_ДБ: str,
    код_статьи_подстатьи_ДБ: str,
    код_элемента_ДБ: str,
    код_группы_ПДБ: str,
    код_группы_АПДБ: str
) -> str:
    """
    Сборка 20-разрядного кода доходов из компонентов
    """
    return (f"{код_ГАДБ:0>3}"
            f"{код_группы_ДБ:0>1}"
            f"{код_подгруппы_ДБ:0>2}"
            f"{код_статьи_подстатьи_ДБ:0>5}"
            f"{код_элемента_ДБ:0>2}"
            f"{код_группы_ПДБ:0>4}"
            f"{код_группы_АПДБ:0>3}")
```

### 4.2. Доработка SolutionController

#### 4.2.1. Обновление _process_appendix1 для работы с компонентами кода

```python
def _process_appendix1(self, table_data: List[List[str]], project_id: int) -> List[Dict[str, Any]]:
    """Обработка Приложения 1 (Доходы) с разбором кода на компоненты"""
    from models.utils.code_utils import parse_income_code
    
    result = []
    # ... существующий код ...
    
    for item in result:
        код = item.get('код', '')
        if код and len(код) == 20:
            # Разбираем код на компоненты
            components = parse_income_code(код)
            item.update(components)
    
    return result
```

#### 4.2.2. Обновление _process_appendix2 для работы с компонентами кода

```python
def _process_appendix2(self, table_data: List[List[str]], project_id: int) -> List[Dict[str, Any]]:
    """Обработка Приложения 2 (Расходы) с разбором кода на компоненты"""
    from models.utils.code_utils import build_expense_code, parse_expense_code
    
    result = []
    # ... существующий код ...
    
    for item in result:
        # Формируем полный код из компонентов
        код_Р = item.get('код_Р', '')
        код_ПР = item.get('код_ПР', '')
        код_ЦС = item.get('код_ЦС', '')
        код_ВР = item.get('код_ВР', '')
        
        # ГРБС нужно получить из справочника или задать по умолчанию
        ГРБС = '000'  # TODO: получить из контекста
        
        полный_код = build_expense_code(ГРБС, код_Р, код_ПР, код_ЦС, код_ВР)
        item['полный_код'] = полный_код
        
        # Также разбираем для проверки
        components = parse_expense_code(полный_код)
        item.update(components)
    
    return result
```

#### 4.2.3. Сохранение данных решений в БД

```python
def save_solution_data(
    self,
    project_id: int,
    solution_data: Dict[str, Any],
    file_path: str
) -> int:
    """Сохранение данных решения в БД с учетом структуры кодов"""
    import sqlite3
    from datetime import datetime
    
    with sqlite3.connect(self.db_manager.db_path) as conn:
        cursor = conn.cursor()
        
        # Сохраняем основную запись решения
        cursor.execute('''
            INSERT INTO solution_data (project_id, solution_file_path, parsed_at)
            VALUES (?, ?, ?)
        ''', (project_id, file_path, datetime.now().isoformat()))
        solution_id = cursor.lastrowid
        
        # Сохраняем Приложение 1 (доходы)
        for item in solution_data.get('приложение1', []):
            cursor.execute('''
                INSERT INTO solution_income_data 
                (solution_id, код, наименование, уровень, ТТ, сумма1, сумма2, сумма3)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                solution_id,
                item.get('код', ''),
                item.get('наименование', ''),
                item.get('уровень', 0),
                item.get('ТТ', 0),
                item.get('сумма1', 0),
                item.get('сумма2', 0),
                item.get('сумма3', 0)
            ))
        
        # Сохраняем Приложение 2 (расходы)
        for item in solution_data.get('приложение2', []):
            cursor.execute('''
                INSERT INTO solution_expense_data 
                (solution_id, код_Р, код_ПР, код_ЦС, код_ВР, уровень, сумма1, сумма2, сумма3, наименование)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                solution_id,
                item.get('код_Р', ''),
                item.get('код_ПР', ''),
                item.get('код_ЦС', ''),
                item.get('код_ВР', ''),
                item.get('уровень', 0),
                item.get('сумма1', 0),
                item.get('сумма2', 0),
                item.get('сумма3', 0),
                item.get('наименование', '')
            ))
        
        # Сохраняем Приложение 3 (расходы по ГРБС)
        for item in solution_data.get('приложение3', []):
            cursor.execute('''
                INSERT INTO solution_expense_grbs_data 
                (solution_id, ГРБС, код_Р, код_ПР, код_ЦС, код_ВР, уровень, сумма1, наименование)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                solution_id,
                item.get('ГРБС', ''),
                item.get('код_Р', ''),
                item.get('код_ПР', ''),
                item.get('код_ЦС', ''),
                item.get('код_ВР', ''),
                item.get('уровень', 0),
                item.get('сумма1', 0),
                item.get('наименование', '')
            ))
        
        conn.commit()
        return solution_id
```

### 4.3. Расширение таблиц БД для хранения компонентов кодов

#### 4.3.1. Добавление полей в solution_income_data

```sql
ALTER TABLE solution_income_data ADD COLUMN код_ГАДБ VARCHAR(3);
ALTER TABLE solution_income_data ADD COLUMN код_группы_ДБ VARCHAR(1);
ALTER TABLE solution_income_data ADD COLUMN код_подгруппы_ДБ VARCHAR(2);
ALTER TABLE solution_income_data ADD COLUMN код_статьи_подстатьи_ДБ VARCHAR(5);
ALTER TABLE solution_income_data ADD COLUMN код_элемента_ДБ VARCHAR(2);
ALTER TABLE solution_income_data ADD COLUMN код_группы_ПДБ VARCHAR(4);
ALTER TABLE solution_income_data ADD COLUMN код_группы_АПДБ VARCHAR(3);
```

#### 4.3.2. Добавление поля ГРБС в solution_expense_data

```sql
ALTER TABLE solution_expense_data ADD COLUMN ГРБС VARCHAR(3);
```

## 5. Приоритеты реализации

### Высокий приоритет:
1. ✅ Создать утилиты для разбора кодов (`code_utils.py`)
2. ⚠️ Обновить `SolutionController` для работы с компонентами кодов
3. ⚠️ Реализовать сохранение данных решений в БД

### Средний приоритет:
5. Расширить таблицы БД для хранения компонентов кодов
6. Добавить валидацию кодов через справочники компонентов
7. Реализовать создание записей в справочниках при отсутствии кода

### Низкий приоритет:
8. Оптимизация работы с кодами
9. Кэширование разобранных кодов
10. UI для просмотра компонентов кодов

## 6. Зависимости

```
code_utils.py
    ├── parse_expense_code()
    ├── build_expense_code()
    ├── parse_income_code()
    └── build_income_code()

SolutionController
    ├── _process_appendix1() [ОБНОВИТЬ - добавить разбор кода]
    ├── _process_appendix2() [ОБНОВИТЬ - добавить разбор кода]
    ├── _process_appendix3() [ОБНОВИТЬ - добавить разбор кода]
    └── save_solution_data() [НОВЫЙ]

DatabaseManager
    └── Миграции для расширения таблиц [НОВЫЕ]
```

## 7. Следующие шаги

1. ✅ Создать файл `models/utils/code_utils.py` с утилитами для работы с кодами
2. Обновить методы обработки приложений в `SolutionController`
3. Реализовать `SolutionController.save_solution_data`
4. Создать миграции БД для расширения таблиц
5. Протестировать разбор и сборку кодов
